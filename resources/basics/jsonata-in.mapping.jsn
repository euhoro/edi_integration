(
  /*
    We will map over the *root* array, which is $ in JSONata.
    Each element of $ is an object with "LX-2400_loop".
  */
  $allLoops := **."LX-2400_loop";

  /*$filtered := $allLoops[size($) = 4];*/


  {
    "service_line_number_LX_loop": $map($allLoops, function($thisSL) {
      {


        "service_line_number_LX": {
          "assigned_number_01": $number($thisSL[0].LX_01),
          "line_item_charge_amount_02": $number($thisSL[1].SV1_02),
          "unit_or_basis_for_measurement_code_03": $thisSL[1].SV1_03,
          "service_unit_count_04": $number($thisSL[1].SV1_04),
          "composite_diagnosis_code_pointer_07": {
            "diagnosis_code_pointer_01": $number($thisSL[1].SV1_07.SV1_07_01),
            "diagnosis_code_pointer_02": $number($thisSL[1].SV1_07.SV1_07_02),
            "diagnosis_code_pointer_03": $number($thisSL[1].SV1_07.SV1_07_03),
            "diagnosis_code_pointer_04": $number($thisSL[1].SV1_07.SV1_07_04)
          }
        },

        "date_service_date_DTP": {
          "date_time_qualifier_01": $thisSL[2].DTP_01,
          "date_time_period_format_qualifier_02": $thisSL[2].DTP_02,
          "service_date_03": $thisSL[2].DTP_03
        },

        "line_adjudication_information_SVD_loop": [
          {
            "line_adjudication_information_SVD": {
              "other_payer_primary_identifier_01": 
                $thisSL[3]."SVD-2430_loop"[SVD_01 != null][0].SVD_01,
              "service_line_paid_amount_02": 
                $number($thisSL[3]."SVD-2430_loop"[SVD_01 != null][0].SVD_02),
              "composite_medical_procedure_identifier_03": {
                "product_or_service_id_qualifier_01": 
                  $thisSL[3]."SVD-2430_loop"[SVD_01 != null][0].SVD_03.SVD_03_01,
                "procedure_code_02": 
                  $thisSL[3]."SVD-2430_loop"[SVD_01 != null][0].SVD_03.SVD_03_02
              },
              "paid_service_unit_count_05": 
                $number($thisSL[3]."SVD-2430_loop"[SVD_01 != null][0].SVD_05)
            },


            "line_adjustment_CAS": $map(
              $thisSL[3]."SVD-2430_loop"[CAS_01 != null],
              function($cas) {
                {
                  "claim_adjustment_group_code_01": $cas.CAS_01,
                  "adjustment_reason_code_02": $cas.CAS_02,
                  "adjustment_amount_03": $number($cas.CAS_03)
                }
              }
            ),


            "line_check_or_remittance_date_DTP": {
              "date_time_qualifier_01": 
                $thisSL[3]."SVD-2430_loop"[DTP_01 != null][0].DTP_01,
              "date_time_period_format_qualifier_02": 
                $thisSL[3]."SVD-2430_loop"[DTP_01 != null][0].DTP_02,
              "adjudication_or_payment_date_03": 
                $thisSL[3]."SVD-2430_loop"[DTP_01 != null][0].DTP_03
            }
          }
        ]
      }
    })
  }
)
